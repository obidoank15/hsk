<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandarin Spark - HSK 1 (Cloud Save)</title>
    
    <!-- Library Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    
    <!-- CSS Internal -->
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #f8f9fa;
            --accent-color: #ffc107;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --text-color: #333;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #fff;
            padding: 20px 30px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { 
            color: var(--primary-color); 
            margin: 0; 
            font-size: 2rem; 
            font-weight: 700;
            flex-grow: 1;
            text-align: center;
        }
        #xp-display {
            background-color: var(--secondary-color);
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-color);
            white-space: nowrap;
        }

        #app-container { display: flex; flex: 1; max-width: 1200px; width: 100%; margin: 20px auto; gap: 20px; padding: 0 20px; box-sizing: border-box; }
        nav { flex: 0 0 250px; background: #fff; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px; height: fit-content; }
        nav h2 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; font-size: 1.25rem; }
        #level-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        #level-selector button { flex: 1; padding: 10px; font-size: 1rem; font-weight: 600; border: 2px solid var(--primary-color); background: #fff; color: var(--primary-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        #level-selector button:hover, #level-selector button.active { background: var(--primary-color); color: #fff; }
        #module-list { list-style: none; padding: 0; margin: 0; max-height: 50vh; overflow-y: auto; }
        #module-list li { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s ease, color 0.2s ease; border: 1px solid #eee; }
        #module-list li:hover { background-color: #f1f8ff; }
        #module-list li.active, #module-list li.chat-active { 
            background-color: var(--primary-color); color: white; 
            font-weight: 600; border-color: var(--primary-color); 
        }
        #ai-chat-btn {
            margin-top: 20px;
            text-align: center;
            font-weight: 700 !important;
            color: #fff;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none !important;
        }
        #ai-chat-btn:hover {
            background: linear-gradient(135deg, #0056b3, #007bff);
        }

        main { flex: 1; background: #fff; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 30px; }
        #content-area h3 { font-size: 1.8rem; color: var(--primary-color); margin-top: 0; }
        .section-title { font-size: 1.5rem; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .flashcard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .flashcard-container { perspective: 1000px; height: 300px; cursor: pointer; } 
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: var(--border-radius); }
        .flashcard-container.is-flipped .flashcard { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: var(--border-radius); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center; }
        .card-front { background: linear-gradient(135deg, #fff, #f9f9f9); border: 1px solid #e0e0e0; }
        .card-front .char { font-size: 4rem; font-weight: 600; margin: 0; color: #222; }
        .card-front .hint { font-size: 0.9rem; color: #aaa; margin-top: 10px; }
        .card-back { background: var(--primary-color); color: white; transform: rotateY(180deg); }
        .card-back .pinyin { font-size: 1.5rem; font-weight: 500; margin: 0; }
        .card-back .translation { font-size: 1.2rem; font-weight: 600; margin-top: 10px; text-transform: capitalize; }
        
        .card-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
        .audio-button, .write-btn, .example-btn {
            border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
            font-size: 0.9rem; padding: 5px 12px; transition: all 0.2s;
        }
        .audio-button { background: var(--accent-color); color: #333; font-size: 1.2rem; width: 40px; height: 40px; border-radius: 50%; padding: 0; }
        .audio-button:hover { transform: scale(1.1); }
        .audio-button.is-loading, .play-audio-btn.is-loading {
            animation: spin 1s linear infinite;
            opacity: 0.7;
            pointer-events: none;
        }

        .write-btn { background-color: #f0f0f0; border: 1px solid #ccc; color: #555; }
        .write-btn:hover { background-color: #e0e0e0; }
        .card-back .write-btn, .card-back .example-btn {
            background-color: rgba(255,255,255,0.2); color: white; border: 1px solid white;
        }
        .card-back .write-btn:hover, .card-back .example-btn:hover { background-color: rgba(255,255,255,0.3); }

        .example-result {
            font-size: 0.8rem; text-align: left; width: 100%;
            background: rgba(0,0,0,0.1); border-radius: 8px;
            padding: 8px; margin-top: 10px; box-sizing: border-box;
            white-space: pre-wrap;
            max-height: 80px; overflow-y: auto; display: none; 
        }

        /* Gaya Kuis Teks */
        #quiz-container { margin-top: 20px; }
        .quiz-question { background: #fdfdfd; border: 1px solid #eee; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03); }
        .quiz-question p { font-size: 1.2rem; font-weight: 600; margin-top: 0; }
        .quiz-question p .char { font-size: 1.5rem; color: var(--primary-color); }
        .quiz-options { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .quiz-options label { display: block; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .quiz-options label:hover { background: #f4f4f4; }
        .quiz-options input { display: none; }
        .quiz-question.correct, .listening-question.correct { border-left: 5px solid var(--correct-color); }
        .quiz-question.incorrect, .listening-question.incorrect { border-left: 5px solid var(--incorrect-color); }
        .quiz-options label.correct, .listening-options label.correct { background-color: #e6f7ec; border-color: var(--correct-color); font-weight: 600; }
        .quiz-options label.incorrect, .listening-options label.incorrect { background-color: #fde8e8; border-color: var(--incorrect-color); }
        
        .quiz-btn, #quiz-result button { padding: 12px 25px; font-size: 1rem; font-weight: 600; background: var(--accent-color); color: #333; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; margin-top: 20px; }
        .quiz-btn:hover { background: #ffb300; transform: translateY(-2px); }
        #quiz-result { margin-top: 20px; font-size: 1.3rem; font-weight: 600; text-align: center; }
        #quiz-result p { margin: 0 0 15px 0; }
        
        #welcome-message { text-align: center; padding: 50px; }
        #welcome-message h2 { font-size: 2rem; color: #555; }
        #welcome-message p { font-size: 1.2rem; color: #777; }

        /* Gaya Modal Menulis */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center;
            position: relative; min-width: 350px;
        }
        .modal-close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 2rem;
            color: #aaa; cursor: pointer; line-height: 1;
        }
        .modal-close-btn:hover { color: #333; }
        #modal-char-title { margin: 0 0 15px 0; font-size: 1.5rem; color: var(--primary-color); }
        #modal-char-title .char { font-size: 2.5rem; color: #333; }
        
        #modal-char-selection p { font-size: 1rem; color: #555; margin-top: 0; }
        .modal-char-btn, .modal-mode-btn {
            display: block; width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;
            border: 2px solid var(--primary-color); background: #fff; color: var(--primary-color);
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease; margin-bottom: 10px;
            box-sizing: border-box;
        }
        .modal-char-btn:hover, .modal-mode-btn:hover { background: var(--primary-color); color: #fff; }
        .modal-char-btn .char {
            font-size: 1.5rem; margin-right: 10px;
        }

        .practice-container { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .practice-controls { display: flex; gap: 10px; justify-content: center; margin: 15px 0 0 0; }
        .practice-controls button, .back-to-mode-btn {
            padding: 8px 15px; font-size: 0.9rem; font-weight: 600;
            background: var(--accent-color); color: #333; border: none;
            border-radius: 8px; cursor: pointer;
        }
        .back-to-mode-btn { background: #777; color: white; }
        #hanzi-writer-target { width: 300px; height: 300px; margin: 0 auto; border: 2px solid #ddd; border-radius: 8px; }
        #hanzi-writer-target svg { width: 100% !important; height: 100% !important; }
        .canvas-container { border: 2px solid #ddd; border-radius: 8px; position: relative; touch-action: none; width: 300px; height: 300px; margin: 0 auto; }
        #writing-canvas { background-color: #fff; cursor: crosshair; display: block; width: 300px; height: 300px; }

        /* Gaya Generator Cerita */
        #story-generator-section {
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 30px;
        }
        #generate-story-btn {
            padding: 12px 25px; font-size: 1rem; font-weight: 600;
            background: var(--primary-color); color: white; border: none;
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
        }
        #generate-story-btn:hover { background: #0056b3; }
        #story-result {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; margin-top: 20px; white-space: pre-wrap;
            line-height: 1.8; text-align: left; display: none;
        }

        /* Gaya Loading Spinner */
        .loading-spinner {
            width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
            margin: 10px auto 0 auto;
        }
        .card-back .loading-spinner {
            border-top-color: #fff;
            width: 20px; height: 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Gaya Modal Alert Kustom */
        #alert-modal .modal-content { min-width: 300px; }
        #alert-modal-text { font-size: 1.1rem; margin-top: 0; }
        #alert-modal-close {
            padding: 10px 20px; font-size: 1rem; font-weight: 600;
            background: var(--primary-color); color: white; border: none;
            border-radius: 8px; cursor: pointer; margin-top: 15px;
        }
        
        /* Gaya Latihan Mendengar */
        #listening-practice-section {
            background: #fdfdfd; border: 1px solid #eee;
            border-radius: var(--border-radius); padding: 20px; margin-top: 30px;
        }
        #start-listening-btn {
            background-color: var(--primary-color); color: white;
        }
        .listening-question {
            background: #fff; border: 1px solid #ddd;
            border-radius: 8px; padding: 20px; margin-top: 15px;
        }
        .play-audio-btn {
            font-size: 2.5rem; background: none; border: none;
            cursor: pointer; display: block; margin: 0 auto 15px auto;
            color: var(--primary-color); transition: transform 0.2s;
        }
        .play-audio-btn:hover { transform: scale(1.1); }
        .listening-options {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .listening-options label {
            display: block; padding: 20px; border: 1px solid #ddd;
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
            text-align: center; font-size: 1.5rem; font-weight: 600;
        }
        .listening-options label:hover { background: #f4f4f4; }
        .listening-options input { display: none; }
        #listening-result {
            text-align: center; font-size: 1.3rem;
            font-weight: 600; margin-top: 20px;
        }
        #listening-result p { margin: 0 0 15px 0; }

        /* Gaya Latihan Pengucapan */
        #pronunciation-practice-section {
            background: #fdfdfd; border: 1px solid #eee;
            border-radius: var(--border-radius); padding: 20px; margin-top: 30px;
        }
        #pronunciation-disclaimer {
            font-size: 0.9rem; background: #fff8e1; border: 1px solid #ffecb3;
            padding: 10px; border-radius: 8px; color: #665200;
        }
        #pronunciation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px; margin-top: 20px;
        }
        .pronunciation-card {
            background: #fff; border: 1px solid #ddd;
            border-radius: 8px; padding: 15px; text-align: center;
        }
        .pronunciation-card .char {
            font-size: 2rem; font-weight: 600; margin-bottom: 5px;
        }
        .pronunciation-card .pinyin {
            font-size: 1rem; color: #777; margin-bottom: 15px;
        }
        .pronounce-btn {
            background: var(--primary-color); color: white;
            border: none; border-radius: 8px; padding: 10px 15px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
        }
        .pronounce-btn:disabled { background: #aaa; }
        .pronounce-btn.is-recording {
            background: var(--incorrect-color);
        }
        .pronunciation-result {
            margin-top: 10px; font-size: 0.9rem; font-weight: 500;
        }
        .pronunciation-result .correct { color: var(--correct-color); }
        .pronunciation-result .incorrect { color: var(--incorrect-color); }

        /* --- Gaya AI Chatbot --- */
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh; /* Tinggi agar pas di area main */
        }
        #chat-log {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 20px;
            background: #fdfdfd;
        }
        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            max-width: 80%;
            line-height: 1.5;
        }
        .user-message {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .ai-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 0;
            white-space: pre-wrap; /* Agar format AI terbaca */
        }
        #chat-input-form {
            display: flex;
            margin-top: 20px;
            gap: 10px;
        }
        #chat-input {
            flex-grow: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1rem;
        }
        #chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        #chat-send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }
        #chat-send-btn:disabled {
            background: #aaa;
        }

        @media (max-width: 768px) {
            #app-container { flex-direction: column; padding: 0 10px; margin: 10px auto; }
            nav { flex: 0 0 auto; width: 100%; box-sizing: border-box; }
            main { width: 100%; box-sizing: border-box; padding: 20px; }
            .flashcard-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .flashcard-container { height: 280px; } 
            .card-front .char { font-size: 3rem; }
            .modal-content { width: 90%; min-width: 0; box-sizing: border-box; }
            #hanzi-writer-target, .canvas-container, #writing-canvas { width: 100%; max-width: 300px; height: 300px; }
            .listening-options { grid-template-columns: 1fr; }
            header { flex-direction: column; gap: 10px; }
            #xp-display { order: 1; }
            header h1 { order: 2; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Mandarin Spark âœ¨</h1>
        <div id="xp-display">Level: 1 | XP: 0/100</div>
    </header>

    <div id="app-container">
        <nav>
            <h2>Pilih Level</h2>
            <div id="level-selector"></div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <h3>Modul Pembelajaran</h3>
            <ul id="module-list">
                <li id="ai-chat-btn">Obrolan AI ğŸ’¬</li>
            </ul>
        </nav>

        <main id="content-area">
            <div id="welcome-message">
                <h2>Selamat Datang!</h2>
                <p>Silakan pilih level HSK dan modul di sebelah kiri untuk memulai.</p>
            </div>
            <!-- Konten (flashcard, kuis, latihan, chat) akan dimuat di sini -->
        </main>
    </div>

    <!-- Modal Latihan Menulis -->
    <div id="writing-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h3 id="modal-char-title">Latihan: </h3>
            
            <div id="modal-char-selection">
                <!-- Tombol karakter akan dibuat oleh JS di sini -->
            </div>

            <div id="modal-mode-selection" style="display: none;">
                <p>Pilih mode latihan:</p>
                <button id="start-aided-btn" class="modal-mode-btn">Animasi & Latihan Terbantu</button>
                <button id="start-free-btn" class="modal-mode-btn">Latihan Bebas (Tanpa Bantuan)</button>
            </div>
            
            <div id="aided-practice-container" class="practice-container" style="display: none;">
                <div id="hanzi-writer-target"></div>
                <div class="practice-controls">
                    <button id="animate-char-btn">Lihat Animasi</button>
                    <button id="practice-char-btn">Latihan Jiplak</button>
                    <button class="back-to-mode-btn">&larr; Kembali</button>
                </div>
            </div>
            
            <div id="free-practice-container" class="practice-container" style="display: none;">
                <p>Tulis <strong id="free-practice-char"></strong> dari ingatan:</p>
                <div class="canvas-container">
                    <canvas id="writing-canvas" width="300" height="300"></canvas>
                </div>
                <div class="practice-controls">
                    <button id="clear-canvas-btn">Hapus</button>
                    <button class="back-to-mode-btn">&larr; Kembali</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal Alert Kustom -->
    <div id="alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p id="alert-modal-text">Pesan alert di sini.</p>
            <button id="alert-modal-close">OK</button>
        </div>
    </div>

    <!-- (BARU) Mengubah skrip menjadi module untuk mendukung import Firebase -->
    <script type="module">
        // (BARU) Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Kunci API Gemini ---
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- DATA JSON (HSK 1 LENGKAP) ---
        const appData = { "hsk1": { title: "HSK 1", modules: [ { title: "1. Sapaan & Perkenalan", vocabulary: [ { char: "ä½ å¥½", pinyin: "nÇ hÇo", translation: "halo" }, { char: "æˆ‘", pinyin: "wÇ’", translation: "saya" }, { char: "ä½ ", pinyin: "nÇ", translation: "kamu" }, { char: "ä»–", pinyin: "tÄ", translation: "dia (laki-laki)" }, { char: "å¥¹", pinyin: "tÄ", translation: "dia (perempuan)" }, { char: "æˆ‘ä»¬", pinyin: "wÇ’men", translation: "kami/kita" }, { char: "å«", pinyin: "jiÃ o", translation: "bernama / memanggil" }, { char: "åå­—", pinyin: "mÃ­ngzi", translation: "nama" }, { char: "è°¢è°¢", pinyin: "xiÃ¨xie", translation: "terima kasih" }, { char: "ä¸å®¢æ°”", pinyin: "bÃº kÃ¨qi", translation: "sama-sama" }, { char: "å†è§", pinyin: "zÃ ijiÃ n", translation: "sampai jumpa" }, { char: "å¯¹ä¸èµ·", pinyin: "duÃ¬buqÇ", translation: "maaf" }, { char: "æ²¡å…³ç³»", pinyin: "mÃ©i guÄnxi", translation: "tidak apa-apa" }, { char: "å–‚", pinyin: "wÃ¨i", translation: "halo (di telepon)" }, { char: "è¯·", pinyin: "qÇng", translation: "silakan / tolong" }, { char: "è®¤è¯†", pinyin: "rÃ¨nshi", translation: "kenal" } ], quiz: [ { question: "Cara bilang 'halo'?", options: ["å†è§", "ä½ å¥½", "è°¢è°¢", "å¯¹ä¸èµ·"], answer: "ä½ å¥½" }, { question: "Respon untuk 'terima kasih'?", options: ["ä¸å®¢æ°”", "æ²¡å…³ç³»", "ä½ å¥½", "å†è§"], answer: "ä¸å®¢æ°”" }, { question: "Apa arti <span class='char'>æˆ‘</span>?", options: ["kamu", "dia", "saya", "nama"], answer: "saya" } ] }, { title: "2. Keluarga & Orang", vocabulary: [ { char: "çˆ¸çˆ¸", pinyin: "bÃ ba", translation: "ayah" }, { char: "å¦ˆå¦ˆ", pinyin: "mÄma", translation: "ibu" }, { char: "å„¿å­", pinyin: "Ã©rzi", translation: "anak laki-laki" }, { char: "å¥³å„¿", pinyin: "nÇš'Ã©r", translation: "anak perempuan" }, { char: "è€å¸ˆ", pinyin: "lÇoshÄ«", translation: "guru" }, { char: "å­¦ç”Ÿ", pinyin: "xuÃ©sheng", translation: "murid" }, { char: "åŒå­¦", pinyin: "tÃ³ngxuÃ©", translation: "teman sekelas" }, { char: "æœ‹å‹", pinyin: "pÃ©ngyou", translation: "teman" }, { char: "å…ˆç”Ÿ", pinyin: "xiÄnsheng", translation: "tuan / suami" }, { char: "å°å§", pinyin: "xiÇojie", translation: "nona" }, { char: "äºº", pinyin: "rÃ©n", translation: "orang" }, { char: "åŒ»ç”Ÿ", pinyin: "yÄ«shÄ“ng", translation: "dokter" } ], quiz: [ { question: "Hanzi untuk 'guru'?", options: ["å­¦ç”Ÿ", "æœ‹å‹", "è€å¸ˆ", "çˆ¸çˆ¸"], answer: "è€å¸ˆ" }, { question: "Apa arti <span class='char'>å¥³å„¿</span>?", options: ["anak laki-laki", "ibu", "anak perempuan", "ayah"], answer: "anak perempuan" }, { question: "Pinyin untuk 'dokter'?", options: ["pÃ©ngyou", "lÇoshÄ«", "yÄ«shÄ“ng", "xuÃ©sheng"], answer: "yÄ«shÄ“ng" } ] }, { title: "3. Angka & Waktu", vocabulary: [ { char: "ä¸€", pinyin: "yÄ«", translation: "satu (1)" }, { char: "äºŒ", pinyin: "Ã¨r", translation: "dua (2)" }, { char: "ä¸‰", pinyin: "sÄn", translation: "tiga (3)" }, { char: "å››", pinyin: "sÃ¬", translation: "empat (4)" }, { char: "äº”", pinyin: "wÇ”", translation: "lima (5)" }, { char: "å…­", pinyin: "liÃ¹", translation: "enam (6)" }, { char: "ä¸ƒ", pinyin: "qÄ«", translation: "tujuh (7)" }, { char: "å…«", pinyin: "bÄ", translation: "delapan (8)" }, { char: "ä¹", pinyin: "jiÇ”", translation: "sembilan (9)" }, { char: "å", pinyin: "shÃ­", translation: "sepuluh (10)" }, { char: "å¹´", pinyin: "niÃ¡n", translation: "tahun" }, { char: "æœˆ", pinyin: "yuÃ¨", translation: "bulan" }, { char: "æ—¥", pinyin: "rÃ¬", translation: "hari/tanggal" }, { char: "æ˜ŸæœŸ", pinyin: "xÄ«ngqÄ«", translation: "minggu" }, { char: "ç‚¹", pinyin: "diÇn", translation: "jam (pukul)" }, { char: "åˆ†é’Ÿ", pinyin: "fÄ“nzhÅng", translation: "menit" }, { char: "æ—¶å€™", pinyin: "shÃ­hou", translation: "waktu / ketika" }, { char: "ç°åœ¨", pinyin: "xiÃ nzÃ i", translation: "sekarang" }, { char: "ä»Šå¤©", pinyin: "jÄ«ntiÄn", translation: "hari ini" }, { char: "æ˜å¤©", pinyin: "mÃ­ngtiÄn", translation: "besok" }, { char: "ä¸Šåˆ", pinyin: "shÃ ngwÇ”", translation: "pagi" }, { char: "ä¸­åˆ", pinyin: "zhÅngwÇ”", translation: "tengah hari" }, { char: "ä¸‹åˆ", pinyin: "xiÃ wÇ”", translation: "sore" } ], quiz: [ { question: "Angka '8' dalam Mandarin?", options: ["å…«", "ä¹", "ä¸ƒ", "å"], answer: "å…«" }, { question: "Apa arti <span class='char'>æ˜å¤©</span>?", options: ["hari ini", "besok", "kemarin", "minggu"], answer: "besok" }, { question: "Hanzi untuk 'jam (pukul)'?", options: ["åˆ†é’Ÿ", "æ—¶å€™", "ç‚¹", "å¹´"], answer: "ç‚¹" } ] }, { title: "4. Makanan & Minuman", vocabulary: [ { char: "æ°´", pinyin: "shuÇ", translation: "air" }, { char: "æ°´æœ", pinyin: "shuÇguÇ’", translation: "buah" }, { char: "è‹¹æœ", pinyin: "pÃ­ngguÇ’", translation: "apel" }, { char: "èŒ¶", pinyin: "chÃ¡", translation: "teh" }, { char: "èœ", pinyin: "cÃ i", translation: "sayur / lauk" }, { char: "ç±³é¥­", pinyin: "mÇfÃ n", translation: "nasi" }, { char: "åƒ", pinyin: "chÄ«", translation: "makan" }, { char: "å–", pinyin: "hÄ“", translation: "minum" }, { char: "æ¯å­", pinyin: "bÄ“izi", translation: "gelas" } ], quiz: [ { question: "Hanzi untuk 'minum'?", options: ["åƒ", "å–", "èœ", "æ°´"], answer: "å–" }, { question: "Apa arti <span class='char'>ç±³é¥­</span>?", options: ["teh", "apel", "nasi", "makan"], answer: "nasi" }, { question: "Karakter untuk 'apel'?", options: ["æ°´æœ", "è‹¹æœ", "æ¯å­", "èŒ¶"], answer: "è‹¹æœ" } ] }, { title: "5. Benda & Belanja", vocabulary: [ { char: "ä¸œè¥¿", pinyin: "dÅngxi", translation: "barang" }, { char: "é’±", pinyin: "qiÃ¡n", translation: "uang" }, { char: "å—", pinyin: "kuÃ i", translation: "yuan (satuan uang)" }, { char: "ä¹°", pinyin: "mÇi", translation: "membeli" }, { char: "å•†åº—", pinyin: "shÄngdiÃ n", translation: "toko" }, { char: "è¡£æœ", pinyin: "yÄ«fu", translation: "baju" }, { char: "ä¹¦", pinyin: "shÅ«", translation: "buku" }, { char: "ç”µè„‘", pinyin: "diÃ nnÇo", translation: "komputer" }, { char: "ç”µè§†", pinyin: "diÃ nshÃ¬", translation: "televisi" }, { char: "ç”µå½±", pinyin: "diÃ nyÇng", translation: "film" }, { char: "æ¡Œå­", pinyin: "zhuÅzi", translation: "meja" }, { char: "æ¤…å­", pinyin: "yÇzi", translation: "kursi" }, { char: "çŒ«", pinyin: "mÄo", translation: "kucing" }, { char: "ç‹—", pinyin: "gÇ’u", translation: "anjing" } ], quiz: [ { question: "Apa arti <span class='char'>ä¹°</span>?", options: ["menjual", "membeli", "toko", "uang"], answer: "membeli" }, { question: "Hanzi untuk 'komputer'?", options: ["ç”µè§†", "ç”µå½±", "ç”µè„‘", "æ¡Œå­"], answer: "ç”µè„‘" }, { question: "Pinyin untuk 'kucing'?", options: ["gÇ’u", "mÄo", "yÄ«fu", "shÅ«"], answer: "mÄo" } ] }, { title: "6. Tempat & Transportasi", vocabulary: [ { char: "å®¶", pinyin: "jiÄ", translation: "rumah/keluarga" }, { char: "å­¦æ ¡", pinyin: "xuÃ©xiÃ o", translation: "sekolah" }, { char: "é¥­åº—", pinyin: "fÃ ndiÃ n", translation: "restoran / hotel" }, { char: "åŒ»é™¢", pinyin: "yÄ«yuÃ n", translation: "rumah sakit" }, { char: "åŒ—äº¬", pinyin: "BÄ›ijÄ«ng", translation: "Beijing" }, { char: "ä¸­å›½", pinyin: "ZhÅngguÃ³", translation: "Cina" }, { char: "å‡ºç§Ÿè½¦", pinyin: "chÅ«zÅ«chÄ“", translation: "taksi" }, { char: "é£æœº", pinyin: "fÄ“ijÄ«", translation: "pesawat" }, { char: "å¼€", pinyin: "kÄi", translation: "mengendarai / membuka" }, { char: "ä½", pinyin: "zhÃ¹", translation: "tinggal" } ], quiz: [ { question: "Apa arti <span class='char'>é¥­åº—</span>?", options: ["toko", "rumah sakit", "restoran / hotel", "sekolah"], answer: "restoran / hotel" }, { question: "Hanzi untuk 'pesawat'?", options: ["å‡ºç§Ÿè½¦", "é£æœº", "å¼€", "ä½"], answer: "é£æœº" } ] }, { title: "7. Kata Kerja Umum", vocabulary: [ { char: "æ˜¯", pinyin: "shÃ¬", translation: "adalah" }, { char: "æœ‰", pinyin: "yÇ’u", translation: "ada / punya" }, { char: "æ²¡æœ‰", pinyin: "mÃ©iyÇ’u", translation: "tidak ada / tidak punya" }, { char: "çˆ±", pinyin: "Ã i", translation: "cinta" }, { char: "å–œæ¬¢", pinyin: "xÇhuan", translation: "suka" }, { char: "æƒ³", pinyin: "xiÇng", translation: "ingin / berpikir" }, { char: "ä¼š", pinyin: "huÃ¬", translation: "bisa (karena belajar)" }, { char: "èƒ½", pinyin: "nÃ©ng", translation: "bisa (secara fisik/situasi)" }, { char: "å»", pinyin: "qÃ¹", translation: "pergi" }, { char: "æ¥", pinyin: "lÃ¡i", translation: "datang" }, { char: "å›", pinyin: "huÃ­", translation: "kembali" }, { char: "å·¥ä½œ", pinyin: "gÅngzuÃ²", translation: "bekerja / pekerjaan" }, { char: "ç¡è§‰", pinyin: "shuÃ¬jiÃ o", translation: "tidur" }, { char: "æ‰“ç”µè¯", pinyin: "dÇ diÃ nhuÃ ", translation: "menelepon" }, { char: "çœ‹", pinyin: "kÃ n", translation: "melihat / membaca" }, { char: "çœ‹è§", pinyin: "kÃ njiÃ n", translation: "melihat (hasil)" }, { char: "å¬", pinyin: "tÄ«ng", translation: "mendengar" }, { char: "è¯´", pinyin: "shuÅ", translation: "berbicara" }, { char: "è¯»", pinyin: "dÃº", translation: "membaca" }, { char: "å†™", pinyin: "xiÄ›", translation: "menulis" }, { char: "å­¦ä¹ ", pinyin: "xuÃ©xÃ­", translation: "belajar" }, { char: "æ±‰è¯­", pinyin: "HÃ nyÇ”", translation: "bahasa Mandarin" }, { char: "å­—", pinyin: "zÃ¬", translation: "karakter/huruf" } ], quiz: [ { question: "Bagaimana bilang 'suka'?", options: ["Ã i", "huÃ¬", "kÃ n", "xÇhuan"], answer: "xÇhuan" }, { question: "Apa arti <span class='char'>å»</span>?", options: ["pergi", "datang", "melihat", "cinta"], answer: "pergi" }, { question: "Hanzi untuk 'tidur'?", options: ["å·¥ä½œ", "ç¡è§‰", "å­¦ä¹ ", "æ‰“ç”µè¯"], answer: "ç¡è§‰" } ] }, { title: "8. Kata Sifat & Keterangan", vocabulary: [ { char: "å¥½", pinyin: "hÇo", translation: "baik" }, { char: "é«˜å…´", pinyin: "gÄoxÃ¬ng", translation: "senang" }, { char: "æ¼‚äº®", pinyin: "piÃ oliang", translation: "cantik" }, { char: "å¤§", pinyin: "dÃ ", translation: "besar" }, { char: "å°", pinyin: "xiÇo", translation: "kecil" }, { char: "å¤š", pinyin: "duÅ", translation: "banyak" }, { char: "å°‘", pinyin: "shÇo", translation: "sedikit" }, { char: "å†·", pinyin: "lÄ›ng", translation: "dingin" }, { char: "çƒ­", pinyin: "rÃ¨", translation: "panas" }, { char: "å¤©æ°”", pinyin: "tiÄnqÃ¬", translation: "cuaca" }, { char: "ä¸‹é›¨", pinyin: "xiÃ  yÇ”", translation: "hujan" }, { char: "å¾ˆ", pinyin: "hÄ›n", translation: "sangat" }, { char: "ä¸", pinyin: "bÃ¹", translation: "tidak" }, { char: "å¤ª", pinyin: "tÃ i", translation: "terlalu" }, { char: "éƒ½", pinyin: "dÅu", translation: "semua / juga" } ], quiz: [ { question: "Lawan kata dari <span class='char'>å¤§</span> (besar)?", options: ["å¤š", "å°‘", "å°", "çƒ­"], answer: "å°" }, { question: "Apa arti <span class='char'>æ¼‚äº®</span>?", options: ["besar", "kecil", "baik", "cantik"], answer: "cantik" }, { question: "Pinyin untuk 'cuaca'?", options: ["rÃ¨", "lÄ›ng", "tiÄnqÃ¬", "xiÃ  yÇ”"], answer: "tiÄnqÃ¬" } ] }, { title: "9. Lokasi & Arah", vocabulary: [ { char: "åœ¨", pinyin: "zÃ i", translation: "di / sedang" }, { char: "è¿™", pinyin: "zhÃ¨", translation: "ini" }, 
            { char: "è¿™å„¿", pinyin: "zhÃ¨r", translation: "di sini" },
            { char: "é‚£", pinyin: "nÃ ", translation: "itu" }, { char: "é‚£å„¿", pinyin: "nÃ r", translation: "di sana" }, { char: "å“ª", pinyin: "nÇ", translation: "yang mana" }, { char: "å“ªå„¿", pinyin: "nÇr", translation: "di mana" }, { char: "ä¸Š", pinyin: "shÃ ng", translation: "atas" }, { char: "ä¸‹", pinyin: "xiÃ ", translation: "bawah" }, { char: "å‰é¢", pinyin: "qiÃ¡nmiÃ n", translation: "depan" }, 
            { char: "åé¢", pinyin: "hÃ²umiÃ n", translation: "belakang" }, 
            { char: "é‡Œ", pinyin: "lÇ", translation: "di dalam" } ], quiz: [ { question: "'Di mana' dalam Mandarin?", options: ["è¿™å„¿", "é‚£å„¿", "å“ªå„¿", "åœ¨"], answer: "å“ªå„¿" }, { question: "Lawan kata <span class='char'>ä¸Š</span> (atas)?", options: ["å‰", "å", "ä¸‹", "é‡Œ"], answer: "ä¸‹" }, { question: "Apa arti <span class='char'>é‡Œ</span>?", options: ["depan", "belakang", "atas", "di dalam"], answer: "di dalam" } ] }, { title: "10. Tanya, Partikel & Satuan", vocabulary: [ { char: "å—", pinyin: "ma", translation: "(partikel 'apakah')" }, { char: "å‘¢", pinyin: "ne", translation: "(partikel 'kalau...')" }, { char: "äº†", pinyin: "le", translation: "(partikel lampau)" }, { char: "çš„", pinyin: "de", translation: "(partikel kepunyaan)" }, { char: "å’Œ", pinyin: "hÃ©", translation: "dan" }, { char: "è°", pinyin: "shÃ©i", translation: "siapa" }, { char: "ä»€ä¹ˆ", pinyin: "shÃ©nme", translation: "apa" }, { char: "å‡ ", pinyin: "jÇ", translation: "berapa (sedikit)" }, { char: "å¤šå°‘", pinyin: "duÅshao", translation: "berapa banyak" }, { char: "æ€ä¹ˆ", pinyin: "zÄ›nme", translation: "bagaimana" }, { char: "æ€ä¹ˆæ ·", pinyin: "zÄ›nmeyÃ ng", translation: "bagaimana (kondisi)" }, { char: "ä¸ª", pinyin: "gÃ¨", translation: "(kata bantu bilangan)" }, { char: "æœ¬", pinyin: "bÄ›n", translation: "(satuan untuk buku)" }, { char: "å²", pinyin: "suÃ¬", translation: "tahun (umur)" }, { char: "äº›", pinyin: "xiÄ“", translation: "beberapa" } ], quiz: [ { question: "Partikel untuk 'Buku **saya**'?", options: ["çš„", "å’Œ", "å—", "å‘¢"], answer: "çš„" }, { question: "Kata tanya untuk 'siapa'?", options: ["ä»€ä¹ˆ", "è°", "å‡ ", "æ€ä¹ˆ"], answer: "è°" }, { question: "Satuan untuk 'buku'?", options: ["ä¸ª", "å²", "äº›", "æœ¬"], answer: "æœ¬" } ] } ] }, "hsk2": { title: "HSK 2", modules: [ { title: "(Contoh) HSK 2", vocabulary: [ { char: "æ˜¨å¤©", pinyin: "zuÃ³tiÄn", translation: "kemarin" }, { char: "æ—©ä¸Š", pinyin: "zÇoshang", translation: "pagi hari" } ], quiz: [ { question: "Apa arti <span class='char'>æ˜¨å¤©</span>?", options: ["hari ini", "besok", "kemarin", "lusa"], answer: "kemarin" } ] } ] } };

        // --- Variabel Global ---
        let currentLevel = null;
        let currentModuleIndex = null;
        // (FIX) Kembalikan synth untuk API browser
        const synth = window.speechSynthesis;

        // --- (BARU) Variabel Firebase ---
        let app, auth, db, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Elemen DOM ---
        const levelSelector = document.getElementById('level-selector');
        const moduleList = document.getElementById('module-list');
        const contentArea = document.getElementById('content-area');
        const welcomeMessage = document.getElementById('welcome-message');
        const aiChatBtn = document.getElementById('ai-chat-btn'); 

        // --- Variabel Modal & Kanvas ---
        const modal = document.getElementById('writing-modal');
        const closeModalBtn = document.querySelector('.modal-close-btn');
        const modalTitle = document.getElementById('modal-char-title');
        const charSelectionDiv = document.getElementById('modal-char-selection');
        const modeSelectionDiv = document.getElementById('modal-mode-selection');
        const aidedPracticeDiv = document.getElementById('aided-practice-container');
        const freePracticeDiv = document.getElementById('free-practice-container');
        const startAidedBtn = document.getElementById('start-aided-btn');
        const startFreeBtn = document.getElementById('start-free-btn');
        const backToModeBtns = document.querySelectorAll('.back-to-mode-btn');
        const canvas = document.getElementById('writing-canvas');
        const ctx = canvas.getContext('2d');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');
        const freePracticeCharSpan = document.getElementById('free-practice-char');
        let drawing = false;
        let writer = null; 
        const animateCharBtn = document.getElementById('animate-char-btn');
        const practiceCharBtn = document.getElementById('practice-char-btn');
        let currentModalChar = ''; 
        let currentModalWord = ''; 
        
        // --- Variabel Modal Alert ---
        const alertModal = document.getElementById('alert-modal');
        const alertModalText = document.getElementById('alert-modal-text');
        const alertModalClose = document.getElementById('alert-modal-close');

        // --- Variabel Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let recognitionIsActive = false;

        // --- Variabel Gamifikasi ---
        let userProgress = {
            xp: 0,
            level: 1,
            xpToNext: 100
        };
        const xpDisplay = document.getElementById('xp-display');

        // --- Variabel AI Chatbot ---
        let chatHistory = [];
        const chatSystemPrompt = `
            Anda adalah seorang tutor Mandarin HSK 1 yang ramah dan sabar bernama "Lao Shi Bot". 
            Pengguna adalah seorang remaja (14 tahun) pemula absolut.
            
            ATURAN KETAT:
            1. SELALU balas dalam bahasa Mandarin yang SANGAT SEDERHANA.
            2. HANYA gunakan kosakata dari daftar HSK 1. Jangan pernah menggunakan kata di luar HSK 1.
            3. Jaga agar balasan tetap pendek (1-2 kalimat).
            4. Jika pengguna bertanya dalam bahasa Indonesia atau Inggris, jawab dalam bahasa Mandarin sederhana seolah-olah Anda tidak mengerti, dan dorong mereka untuk mencoba dalam bahasa Mandarin. (Contoh: "ä½ å¥½! è¯·è¯´æ±‰è¯­ã€‚")
            5. Mulailah percakapan pertama dengan menyapa dan menanyakan nama mereka.
        `;


        // --- (BARU) Fungsi Setup Firebase ---
        async function setupFirebase() {
            try {
                // Gunakan variabel global yang disediakan oleh platform
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentikasi pengguna
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized and user authenticated:", userId);
                
            } catch (error) {
                console.error("Firebase setup failed:", error);
                showCustomAlert("Gagal terhubung ke database. Progres tidak akan disimpan.");
                userId = crypto.randomUUID(); // Fallback agar XP tetap berfungsi lokal
            }
        }

        // --- Fungsi Utama ---
        document.addEventListener('DOMContentLoaded', async () => {
            // (BARU) Menunggu Firebase siap sebelum memuat progres
            await setupFirebase(); 
            
            await loadProgress(); // (BARU) Sekarang async
            loadLevelSelector();
            if (Object.keys(appData).length > 0) {
                const defaultLevel = Object.keys(appData)[0];
                selectLevel(defaultLevel);
            }
            setupFreePracticeCanvas();
            setupModalListeners();
            setupCustomAlertModal(); 
            setupSpeechRecognition(); 
            aiChatBtn.addEventListener('click', loadAIChatInterface); 
        });

        // --- Fungsi Gamifikasi (Diperbarui untuk Firebase) ---
        async function loadProgress() {
            // (BARU) Keluar jika db tidak siap
            if (!db || !userId) {
                console.warn("Firestore not ready, loading default progress.");
                updateXPDisplay();
                return;
            }
            
            try {
                // (BARU) Tentukan path dokumen yang benar
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/progress`, "userStats");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    userProgress = docSnap.data();
                } else {
                    console.log("No progress found, creating new one.");
                    await saveProgress(); // Simpan status default ke DB
                }
            } catch (error) {
                console.error("Error loading progress:", error);
                // Muat default jika ada error
            }
            updateXPDisplay();
        }

        async function saveProgress() {
            updateXPDisplay(); // Update UI langsung
            
            // (BARU) Keluar jika db tidak siap
            if (!db || !userId) {
                console.warn("Firestore not ready, cannot save progress.");
                return;
            }

            try {
                 // (BARU) Tentukan path dokumen yang benar
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/progress`, "userStats");
                // (BARU) Gunakan setDoc untuk menyimpan
                await setDoc(docRef, userProgress, { merge: true }); // Merge agar tidak menimpa data lain
            } catch (error) {
                console.error("Error saving progress:", error);
            }
        }

        function updateXPDisplay() {
            xpDisplay.innerText = `Level: ${userProgress.level} | XP: ${userProgress.xp} / ${userProgress.xpToNext}`;
        }

        function addXP(points) {
            userProgress.xp += points;
            let levelUp = false;
            while (userProgress.xp >= userProgress.xpToNext) {
                levelUp = true;
                userProgress.level++;
                userProgress.xp -= userProgress.xpToNext;
                userProgress.xpToNext = Math.floor(userProgress.xpToNext * 1.5); 
            }
            if (levelUp) {
                showCustomAlert(`ğŸ‰ Level Up! Kamu sekarang Level ${userProgress.level}!`);
            }
            saveProgress(); // Ini sekarang async, akan berjalan di latar belakang
        }

        // --- Fungsi Pemuatan Konten ---
        function loadLevelSelector() {
            levelSelector.innerHTML = '';
            for (const levelKey in appData) {
                const level = appData[levelKey];
                const button = document.createElement('button');
                button.innerText = level.title;
                button.dataset.level = levelKey;
                button.onclick = () => selectLevel(levelKey);
                levelSelector.appendChild(button);
            }
        }
        function selectLevel(levelKey) {
            currentLevel = levelKey;
            Array.from(levelSelector.children).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.level === levelKey);
            });
            loadModuleMenu(levelKey);
            contentArea.innerHTML = '';
            contentArea.appendChild(welcomeMessage);
            welcomeMessage.style.display = 'block';
        }
        function loadModuleMenu(levelKey) {
            moduleList.innerHTML = '';
            moduleList.appendChild(aiChatBtn); 
            aiChatBtn.classList.remove('chat-active');
            
            if (appData[levelKey] && appData[levelKey].modules) {
                const modules = appData[levelKey].modules;
                modules.forEach((module, index) => {
                    const li = document.createElement('li');
                    li.innerText = module.title;
                    li.dataset.index = index;
                    li.onclick = () => loadModuleContent(levelKey, index);
                    moduleList.appendChild(li);
                });
            } else {
                console.error("Error: Tidak dapat menemukan modul untuk level:", levelKey);
            }
        }

        function clearActiveModules() {
            Array.from(moduleList.children).forEach(li => {
                li.classList.remove('active');
                li.classList.remove('chat-active');
            });
        }

        function loadModuleContent(levelKey, moduleIndex) {
            currentLevel = levelKey;
            currentModuleIndex = moduleIndex;
            welcomeMessage.style.display = 'none';
            
            clearActiveModules();
            moduleList.querySelector(`li[data-index="${moduleIndex}"]`).classList.add('active');

            const module = appData[levelKey].modules[moduleIndex];
            contentArea.innerHTML = ''; 
            const title = document.createElement('h3');
            title.innerText = module.title;
            contentArea.appendChild(title);
            if (module.vocabulary && module.vocabulary.length > 0) {
                contentArea.appendChild(renderVocabulary(module.vocabulary));
            }
            if (module.quiz && module.quiz.length > 0) {
                contentArea.appendChild(renderQuiz(module.quiz));
            }
            if (module.vocabulary && module.vocabulary.length > 4) { 
                contentArea.appendChild(renderListeningPractice(module));
            }
            if (module.vocabulary && module.vocabulary.length > 0) {
                contentArea.appendChild(renderPronunciationPractice(module));
            }
            if (module.vocabulary && module.vocabulary.length > 0) {
                contentArea.appendChild(renderStoryGenerator(module));
            }
        }

        // --- Fungsi AI Chatbot ---
        function loadAIChatInterface() {
            clearActiveModules();
            aiChatBtn.classList.add('chat-active');
            welcomeMessage.style.display = 'none';
            
            contentArea.innerHTML = `
                <h3>Obrolan AI ğŸ’¬</h3>
                <div id="chat-container">
                    <div id="chat-log">
                        <!-- Pesan chat akan muncul di sini -->
                    </div>
                    <form id="chat-input-form">
                        <input type="text" id="chat-input" placeholder="Ketik dalam bahasa Mandarin..." autocomplete="off">
                        <button id="chat-send-btn">Kirim</button>
                    </form>
                </div>
            `;
            
            const chatForm = document.getElementById('chat-input-form');
            chatForm.addEventListener('submit', handleChatSubmit);

            if (chatHistory.length === 0) {
                chatHistory.push({ role: "system", parts: [{ text: chatSystemPrompt }] });
                callChatGemini(); 
            } else {
                const chatLog = document.getElementById('chat-log');
                chatHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        renderChatMessage(msg.parts[0].text, 'user', chatLog);
                    } else if (msg.role === 'model') {
                        renderChatMessage(msg.parts[0].text, 'ai', chatLog);
                    }
                });
            }
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            const chatLog = document.getElementById('chat-log');
            const userMessage = input.value.trim();

            if (userMessage === '') return;

            input.value = '';
            input.disabled = true;
            sendBtn.disabled = true;

            renderChatMessage(userMessage, 'user', chatLog);
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            await callChatGemini();

            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        function renderChatMessage(message, sender, chatLog) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${sender}-message`;
            msgDiv.innerText = message;
            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight; 
        }

        async function callChatGemini() {
            const chatLog = document.getElementById('chat-log');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message ai-message';
            loadingDiv.innerHTML = '<div class="loading-spinner" style="margin: 0; border-top-color: var(--primary-color);"></div>';
            chatLog.appendChild(loadingDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            const payload = {
                contents: chatHistory,
                systemInstruction: chatHistory.length <= 1 ? { parts: [{ text: chatSystemPrompt }] } : undefined,
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const result = await fetchWithBackoff(apiUrl, options); 
                chatLog.removeChild(loadingDiv); 

                if (result.candidates && result.candidates[0].content) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    renderChatMessage(aiResponse, 'ai', chatLog);
                    addXP(5); 
                } else {
                    renderChatMessage("Maaf, terjadi kesalahan. Coba lagi.", 'ai', chatLog);
                    console.error('Respons API Chat tidak valid:', result);
                }
            } catch (error) {
                chatLog.removeChild(loadingDiv);
                console.error('Error memanggil Gemini Chat API:', error);
                renderChatMessage("Gagal terhubung ke AI. Cek koneksi Anda.", 'ai', chatLog);
            }
        }


        // --- Fungsi Render ---
        function renderVocabulary(vocabularyList) {
            const section = document.createElement('div');
            const title = document.createElement('h4');
            title.className = 'section-title';
            title.innerText = 'ğŸ“š Kosakata (Flashcards)';
            section.appendChild(title);
            const grid = document.createElement('div');
            grid.className = 'flashcard-grid';
            vocabularyList.forEach(item => {
                const uniqueId = `${item.char}-${Math.random().toString(36).substr(2, 9)}`;
                const cardContainer = document.createElement('div');
                cardContainer.className = 'flashcard-container';
                const card = document.createElement('div');
                card.className = 'flashcard';
                // Sisi Depan
                const front = document.createElement('div');
                front.className = 'card-face card-front';
                front.innerHTML = `
                    <div class="char">${item.char}</div>
                    <div class="card-actions">
                        <button class="write-btn" data-char="${item.char}">Tulis âœï¸</button>
                    </div>
                    <div class="hint">(Klik untuk lihat arti)</div>
                `;
                // Sisi Belakang
                const back = document.createElement('div');
                back.className = 'card-face card-back';
                back.innerHTML = `
                    <div class="pinyin">${item.pinyin}</div>
                    <div class="translation">${item.translation}</div>
                    <div class="card-actions">
                        <button class="audio-button" data-char="${item.char}">ğŸ”Š</button>
                        <button class="write-btn" data-char="${item.char}">Tulis âœï¸</button>
                        <button class="example-btn" 
                                data-char="${item.char}" 
                                data-pinyin="${item.pinyin}" 
                                data-translation="${item.translation}"
                                data-target="example-${uniqueId}">Contoh âœ¨</button>
                    </div>
                    <div class="loading-spinner" id="loading-${uniqueId}" style="display: none;"></div>
                    <div class="example-result" id="example-${uniqueId}"></div>
                `;
                card.appendChild(front);
                card.appendChild(back);
                cardContainer.appendChild(card);
                grid.appendChild(cardContainer);
                
                // Event listener
                cardContainer.addEventListener('click', (e) => {
                    const ignored = ['audio-button', 'write-btn', 'example-btn'];
                    if (ignored.some(cls => e.target.classList.contains(cls))) {
                        return;
                    }
                    cardContainer.classList.toggle('is-flipped');
                });
                back.querySelector('.audio-button').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    speak(item.char, e.target); 
                });
                card.querySelectorAll('.write-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openWritingModal(e.target.dataset.char);
                    });
                });
                back.querySelector('.example-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const char = e.target.dataset.char;
                    const pinyin = e.target.dataset.pinyin;
                    const translation = e.target.dataset.translation;
                    const targetId = e.target.dataset.target;
                    handleExampleGeneration(char, pinyin, translation, targetId);
                });
            });
            section.appendChild(grid);
            return section;
        }

        function renderQuiz(quizItems) {
            const section = document.createElement('div');
            section.id = 'quiz-container';
            const title = document.createElement('h4');
            title.className = 'section-title';
            title.innerText = 'âœï¸ Kuis Cepat (Teks)';
            section.appendChild(title);
            const form = document.createElement('form');
            form.id = 'quiz-form';
            quizItems.forEach((item, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'quiz-question';
                qDiv.dataset.questionIndex = index; 
                const qText = document.createElement('p');
                qText.innerHTML = `Q${index + 1}: ${item.question}`;
                qDiv.appendChild(qText);
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'quiz-options';
                const shuffledOptions = shuffleArray([...item.options]);
                shuffledOptions.forEach((option, optionIndex) => {
                    const label = document.createElement('label');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `q${index}`;
                    radio.value = option;
                    label.appendChild(radio);
                    label.append(option); 
                    optionsDiv.appendChild(label);
                });
                qDiv.appendChild(optionsDiv);
                form.appendChild(qDiv);
            });
            section.appendChild(form);
            const checkButton = document.createElement('button');
            checkButton.id = 'check-quiz-btn'; 
            checkButton.className = 'quiz-btn'; 
            checkButton.innerText = 'Periksa Jawaban Kuis Teks';
            checkButton.onclick = (e) => { e.preventDefault(); checkQuiz(); };
            section.appendChild(checkButton);
            const resultDiv = document.createElement('div');
            resultDiv.id = 'quiz-result';
            section.appendChild(resultDiv);
            return section;
        }

        function renderListeningPractice(module) {
            const section = document.createElement('div');
            section.id = 'listening-practice-section';
            
            const title = document.createElement('h4');
            title.className = 'section-title';
            title.innerText = 'ğŸ§ Latihan Mendengar';
            section.appendChild(title);

            const startBtn = document.createElement('button');
            startBtn.id = 'start-listening-btn';
            startBtn.className = 'quiz-btn';
            startBtn.innerText = 'Mulai Latihan Mendengar';
            section.appendChild(startBtn);

            const container = document.createElement('div');
            container.id = 'listening-quiz-container';
            container.style.display = 'none';
            section.appendChild(container);
            
            const resultDiv = document.createElement('div');
            resultDiv.id = 'listening-result';
            section.appendChild(resultDiv);
            
            let listeningQuestions = [];
            let currentListeningQuestion = 0;
            let listeningScore = 0;

            startBtn.onclick = () => {
                listeningQuestions = generateListeningQuestions(module.vocabulary);
                currentListeningQuestion = 0;
                listeningScore = 0;
                container.style.display = 'block';
                resultDiv.innerHTML = '';
                startBtn.style.display = 'none';
                displayListeningQuestion(listeningQuestions[currentListeningQuestion]);
            };

            function generateListeningQuestions(vocabList) {
                const shuffledVocab = shuffleArray([...vocabList]);
                return shuffledVocab.slice(0, 5).map(correctItem => {
                    let options = [correctItem.char];
                    let otherOptions = shuffleArray([...vocabList].filter(v => v.char !== correctItem.char));
                    options.push(otherOptions[0].char, otherOptions[1].char, otherOptions[2].char);
                    return {
                        audioChar: correctItem.char,
                        options: shuffleArray(options),
                        answer: correctItem.char
                    };
                });
            }

            function displayListeningQuestion(q) {
                container.innerHTML = '';
                const qDiv = document.createElement('div');
                qDiv.className = 'listening-question';
                
                const playBtn = document.createElement('button');
                playBtn.className = 'play-audio-btn';
                playBtn.innerText = 'ğŸ”Š';
                playBtn.onclick = (e) => speak(q.audioChar, e.target); 
                qDiv.appendChild(playBtn);
                
                const p = document.createElement('p');
                p.style.textAlign = 'center';
                p.innerText = 'Pilih karakter yang Anda dengar:';
                qDiv.appendChild(p);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'listening-options';
                
                q.options.forEach(option => {
                    const label = document.createElement('label');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'listen-q';
                    radio.value = option;
                    radio.onchange = () => checkListeningAnswer(q, radio.value, qDiv, optionsDiv);
                    
                    label.appendChild(radio);
                    label.append(option);
                    optionsDiv.appendChild(label);
                });
                
                qDiv.appendChild(optionsDiv);
                container.appendChild(qDiv);
                setTimeout(() => speak(q.audioChar, playBtn), 300); 
            }

            function checkListeningAnswer(q, selected, qDiv, optionsDiv) {
                optionsDiv.querySelectorAll('input').forEach(r => r.disabled = true);
                const correctLabel = optionsDiv.querySelector(`input[value="${q.answer}"]`).parentElement;
                
                if (selected === q.answer) {
                    listeningScore++;
                    qDiv.classList.add('correct');
                    correctLabel.classList.add('correct');
                    addXP(15); 
                } else {
                    qDiv.classList.add('incorrect');
                    correctLabel.classList.add('correct'); 
                    optionsDiv.querySelector(`input[value="${selected}"]`).parentElement.classList.add('incorrect');
                }

                setTimeout(() => {
                    currentListeningQuestion++;
                    if (currentListeningQuestion < listeningQuestions.length) {
                        displayListeningQuestion(listeningQuestions[currentListeningQuestion]);
                    } else {
                        showListeningResults();
                    }
                }, 1500);
            }

            function showListeningResults() {
                container.style.display = 'none';
                startBtn.style.display = 'block';
                startBtn.innerText = 'Ulangi Latihan Mendengar';
                
                let scoreMessage = `Skor Latihan Mendengar: ${listeningScore} dari ${listeningQuestions.length}!`;
                if (listeningScore === listeningQuestions.length) scoreMessage = `ğŸ‰ Hebat! ${scoreMessage}`;
                else if (listeningScore >= listeningQuestions.length / 2) scoreMessage = `ğŸ‘ Bagus! ${scoreMessage}`;
                else scoreMessage = `ğŸ¤” Coba lagi! ${scoreMessage}`;
                
                resultDiv.innerHTML = `<p>${scoreMessage}</p>`;
            }

            return section;
        }

        function renderPronunciationPractice(module) {
            const section = document.createElement('div');
            section.id = 'pronunciation-practice-section';
            
            const title = document.createElement('h4');
            title.className = 'section-title';
            title.innerText = 'ğŸ™ï¸ Latihan Pengucapan';
            section.appendChild(title);

            const disclaimer = document.createElement('p');
            disclaimer.id = 'pronunciation-disclaimer';
            if (recognition) {
                disclaimer.innerHTML = "<strong>PENTING:</strong> Fitur ini eksperimental. Klik 'Rekam', ucapkan kata, dan kami akan periksa transkripsinya. Ini <strong>tidak menilai nada (tone)</strong> dan berfungsi paling baik di Chrome/Edge.";
            } else {
                disclaimer.innerHTML = "<strong>Pemberitahuan:</strong> API Pengenalan Suara (Speech Recognition) tidak didukung atau tidak diizinkan di browser Anda. Fitur latihan pengucapan dinonaktifkan.";
            }
            section.appendChild(disclaimer);

            const grid = document.createElement('div');
            grid.id = 'pronunciation-grid';
            section.appendChild(grid);

            if (!recognition) return section; 

            module.vocabulary.forEach(item => {
                const card = document.createElement('div');
                card.className = 'pronunciation-card';
                
                card.innerHTML = `
                    <div class="char">${item.char}</div>
                    <div class="pinyin">${item.pinyin}</div>
                    <button class="pronounce-btn" data-char="${item.char}">Rekam ğŸ™ï¸</button>
                    <div class="pronunciation-result"></div>
                `;
                
                card.querySelector('.pronounce-btn').onclick = (e) => {
                    handlePronunciationPractice(e, item.char);
                };
                grid.appendChild(card);
            });

            return section;
        }

        function renderStoryGenerator(module) {
            const section = document.createElement('div');
            section.id = 'story-generator-section';
            const title = document.createElement('h4');
            title.className = 'section-title';
            title.innerHTML = 'âœ¨ Generator Cerita Mini';
            section.appendChild(title);
            const p = document.createElement('p');
            p.innerText = 'Uji pemahamanmu! Klik tombol di bawah untuk membuat AI membuat cerita super pendek hanya menggunakan kosakata dari modul ini.';
            section.appendChild(p);
            const btn = document.createElement('button');
            btn.id = 'generate-story-btn';
            btn.innerText = 'Buat Cerita!';
            btn.onclick = () => handleStoryGeneration(module);
            section.appendChild(btn);
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'story-loading';
            loadingDiv.className = 'loading-spinner';
            loadingDiv.style.display = 'none';
            section.appendChild(loadingDiv);
            const resultDiv = document.createElement('div');
            resultDiv.id = 'story-result';
            section.appendChild(resultDiv);
            return section;
        }

        // --- Kuis & Fungsi Lainnya ---
        function checkQuiz() {
            const quizItems = appData[currentLevel].modules[currentModuleIndex].quiz;
            const form = document.getElementById('quiz-form');
            const resultDiv = document.getElementById('quiz-result');
            let score = 0;
            quizItems.forEach((item, index) => {
                const qDiv = form.querySelector(`.quiz-question[data-question-index="${index}"]`);
                const selected = form.querySelector(`input[name="q${index}"]:checked`);
                qDiv.classList.remove('correct', 'incorrect');
                qDiv.querySelectorAll('label').forEach(l => l.classList.remove('correct', 'incorrect'));
                if (selected) {
                    const userAnswer = selected.value;
                    const correctAnswer = item.answer;
                    const correctLabel = qDiv.querySelector(`input[value="${correctAnswer}"]`).parentElement;
                    if (userAnswer === correctAnswer) {
                        score++;
                        qDiv.classList.add('correct');
                        correctLabel.classList.add('correct');
                        addXP(10); 
                    } else {
                        qDiv.classList.add('incorrect');
                        selected.parentElement.classList.add('incorrect');
                        correctLabel.classList.add('correct');
                    }
                } else {
                    qDiv.classList.add('incorrect');
                }
            });
            let scoreMessage = `Skor Kuis Teks: ${score} dari ${quizItems.length}!`;
            if (score === quizItems.length) scoreMessage = `ğŸ‰ Hebat! ${scoreMessage}`;
            else if (score >= quizItems.length / 2) scoreMessage = `ğŸ‘ Bagus! ${scoreMessage}`;
            else scoreMessage = `ğŸ¤” Coba lagi! ${scoreMessage}`;
            resultDiv.innerHTML = `<p>${scoreMessage}</p><button onclick="retryQuiz()">Ulangi Kuis</button>`;
            document.getElementById('check-quiz-btn').style.display = 'none';
        }
        function retryQuiz() { loadModuleContent(currentLevel, currentModuleIndex); }
        
        // --- (FIX) Perbaikan Fungsi 'speak' ---
        function speak(text, buttonElement = null) {
            // (FIX) Kembalikan ke API browser
            if (!synth) {
                console.error("Speech Synthesis API not supported.");
                showCustomAlert("Maaf, fitur audio (Text-to-Speech) tidak didukung di browser Anda.");
                return;
            }

            if (buttonElement) {
                buttonElement.classList.add('is-loading');
                buttonElement.disabled = true;
            }

            if (synth.speaking) {
                synth.cancel(); // Hentikan audio sebelumnya jika ada
            }
            
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'zh-CN';
            utterThis.pitch = 1;
            utterThis.rate = 0.8;
            
            utterThis.onend = function() {
                if (buttonElement) {
                    buttonElement.classList.remove('is-loading');
                    buttonElement.disabled = false;
                }
            };
            
            utterThis.onerror = function(e) {
                console.error("Speech Synthesis error:", e);
                if (buttonElement) {
                    buttonElement.classList.remove('is-loading');
                    buttonElement.disabled = false;
                }
                showCustomAlert("Gagal memutar audio. " + e.error);
            };

            // Tambahkan sedikit jeda untuk mengatasi 'race condition' di beberapa browser
            setTimeout(() => {
                 synth.speak(utterThis);
            }, 100);
        }


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        function setupCustomAlertModal() {
            alertModalClose.addEventListener('click', () => {
                alertModal.style.display = 'none';
            });
            alertModal.addEventListener('click', (e) => {
                if (e.target === alertModal) {
                    alertModal.style.display = 'none';
                }
            });
        }
        function showCustomAlert(message) {
            alertModalText.innerText = message;
            alertModal.style.display = 'flex';
        }

        // --- Fungsi Latihan Pengucapan ---
        function setupSpeechRecognition() {
            if (!SpeechRecognition) {
                console.log("Speech Recognition API tidak didukung di browser ini.");
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; 
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                recognitionIsActive = true;
            };

            recognition.onend = () => {
                recognitionIsActive = false;
                document.querySelectorAll('.pronounce-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('is-recording');
                    btn.innerText = 'Rekam ğŸ™ï¸';
                });
            };

            recognition.onerror = (event) => {
                recognitionIsActive = false;
                console.error("Speech recognition error", event.error);
                let errorMsg = "Terjadi error: " + event.error;
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    errorMsg = "Izin mikrofon ditolak. Harap izinkan akses mikrofon di pengaturan browser Anda.";
                    showCustomAlert(errorMsg);
                }
                const recordingBtn = document.querySelector('.pronounce-btn.is-recording');
                if (recordingBtn) {
                    const resultDiv = recordingBtn.nextElementSibling;
                    resultDiv.innerHTML = `<span class="incorrect">Error: ${event.error}</span>`;
                }
            };
        }

        function handlePronunciationPractice(event, targetChar) {
            if (!recognition) {
                showCustomAlert("Maaf, API pengenalan suara tidak didukung di browser Anda.");
                return;
            }

            if (recognitionIsActive) {
                recognition.stop();
                return;
            }

            const btn = event.target;
            const resultDiv = btn.nextElementSibling; 

            document.querySelectorAll('.pronounce-btn').forEach(b => {
                if (b !== btn) b.disabled = true;
            });
            
            btn.classList.add('is-recording');
            btn.innerText = 'Mendengar...';
            resultDiv.innerHTML = 'Silakan bicara...';

            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                comparePronunciation(transcript, targetChar, resultDiv);
            };

            recognition.start();
        }

        function comparePronunciation(transcript, target, resultDiv) {
            const normalizedTranscript = transcript.replace(/[\sã€‚ï¼Œ]/g, '');
            const normalizedTarget = target.replace(/[\sã€‚ï¼Œ]/g, '');

            if (normalizedTranscript === normalizedTarget) {
                resultDiv.innerHTML = `<span class="correct">âœ” Benar!</span> Anda berkata: ${transcript}`;
                addXP(2); 
            } else {
                resultDiv.innerHTML = `
                    <span class="incorrect">âœ˜ Coba lagi.</span>
                    <div>Anda berkata: ${transcript}</div>
                    <div>Yang Diharapkan: ${target}</div>
                `;
            }
        }

        // --- Fungsi Modal Menulis ---
        function cleanupHanziWriter() {
            if (writer) {
                writer.cancelQuiz(); 
                writer = null; 
            }
            document.getElementById('hanzi-writer-target').innerHTML = '';
        }

        function setupModalListeners() {
            closeModalBtn.addEventListener('click', closeWritingModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeWritingModal();
            });
            
            backToModeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    cleanupHanziWriter();
                    const chars = Array.from(currentModalWord);
                    if (chars.length > 1) {
                        populateCharSelection(chars); 
                    } else {
                        showPracticeModesForChar(currentModalChar); 
                    }
                });
            });
            
            startAidedBtn.addEventListener('click', startAidedPractice);
            startFreeBtn.addEventListener('click', startFreePractice);
            
            animateCharBtn.addEventListener('click', () => {
                if (writer) writer.animateCharacter();
            });
            
            practiceCharBtn.addEventListener('click', () => {
                if (writer) {
                    writer.quiz({
                        onMistake: (strokeData) => console.log('Salah goresan!', strokeData),
                        onCorrectStroke: (strokeData) => console.log('Goresan benar!', strokeData),
                        onComplete: (summary) => {
                            console.log('Latihan selesai!', summary);
                            setTimeout(() => showCustomAlert('Bagus! Kamu menyelesaikan latihan jiplak.'), 100);
                            addXP(5); 
                        }
                    });
                }
            });
        }

        function openWritingModal(word) {
            currentModalWord = word; 
            modalTitle.innerHTML = `Latihan: <span class="char">${word}</span>`;
            cleanupHanziWriter();
            modal.style.display = 'flex';
            const chars = Array.from(word); 
            if (chars.length === 1) {
                showPracticeModesForChar(chars[0]);
            } else {
                populateCharSelection(chars);
            }
        }

        function populateCharSelection(chars) {
            charSelectionDiv.innerHTML = '<p>Pilih karakter yang ingin dilatih:</p>'; 
            chars.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'modal-char-btn';
                btn.innerHTML = `<span class="char">${char}</span> Latih`;
                btn.onclick = () => {
                    showPracticeModesForChar(char);
                };
                charSelectionDiv.appendChild(btn);
            });
            cleanupHanziWriter();
            charSelectionDiv.style.display = 'block';
            modeSelectionDiv.style.display = 'none';
            aidedPracticeDiv.style.display = 'none';
            freePracticeDiv.style.display = 'none';
        }

        function showPracticeModesForChar(char) {
            currentModalChar = char; 
            cleanupHanziWriter();
            charSelectionDiv.style.display = 'none';
            modeSelectionDiv.style.display = 'block';
            aidedPracticeDiv.style.display = 'none';
            freePracticeDiv.style.display = 'none';
        }

        function closeWritingModal() {
            modal.style.display = 'none';
            cleanupHanziWriter();
        }

        function startAidedPractice() {
            modeSelectionDiv.style.display = 'none';
            aidedPracticeDiv.style.display = 'block';
            cleanupHanziWriter();
            const targetElement = document.getElementById('hanzi-writer-target');
            if (targetElement) {
                writer = HanziWriter.create(targetElement, currentModalChar, {
                    width: 300, height: 300, padding: 20, showOutline: true,
                    strokeAnimationSpeed: 1, delayBetweenStrokes: 100,
                    strokeColor: '#007bff', outlineColor: '#ddd'
                });
            } else {
                console.error("Tidak dapat menemukan elemen target hanzi-writer!");
            }
        }

        function startFreePractice() {
            modeSelectionDiv.style.display = 'none';
            freePracticeDiv.style.display = 'block';
            freePracticeCharSpan.innerText = currentModalChar; 
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            clearCanvas();
        }

        function setupFreePracticeCanvas() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            clearCanvasBtn.addEventListener('click', clearCanvas);
        }
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#333'; ctx.lineWidth = 5;
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.beginPath();
        }
        function startDrawing(e) {
            drawing = true;
            const { x, y } = getCoords(e);
            ctx.beginPath(); ctx.moveTo(x, y);
            e.preventDefault();
        }
        function stopDrawing() { drawing = false; }
        function draw(e) {
            if (!drawing) return;
            const { x, y } = getCoords(e);
            ctx.lineTo(x, y); ctx.stroke();
            e.preventDefault();
        }
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        // --- FUNGSI GEMINI API (Lainnya) ---
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    lastError = error;
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    }
                }
            }
            throw lastError; 
        }
        async function callGemini(prompt, loadingElement, resultElement) {
            loadingElement.style.display = 'block';
            resultElement.style.display = 'none';
            resultElement.innerText = ''; 
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };
            try {
                const result = await fetchWithBackoff(apiUrl, options); 
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    resultElement.innerText = text; 
                } else {
                    resultElement.innerText = 'Maaf, tidak ada respons yang valid dari AI.';
                    console.error('Respons API tidak valid:', result);
                }
            } catch (error) {
                console.error('Error memanggil Gemini API:', error);
                resultElement.innerText = 'Gagal memuat. Coba lagi nanti.';
            } finally {
                loadingElement.style.display = 'none';
                resultElement.style.display = 'block';
            }
        }
        async function handleExampleGeneration(char, pinyin, translation, targetId) {
            const loadingElement = document.getElementById(`loading-${targetId.replace('example-', '')}`);
            const resultElement = document.getElementById(targetId);
            if (resultElement.innerText.trim() !== '') {
                resultElement.style.display = 'block';
                return;
            }
            const prompt = `
            Buatkan 2 kalimat contoh yang sangat sederhana untuk pemula HSK 1 menggunakan karakter Mandarin "${char}" (pinyin: ${pinyin}, arti: ${translation}).
            
            PENTING:
            1. Gunakan hanya kosakata HSK 1 lainnya jika memungkinkan.
            2. Berikan format yang jelas:
               1. Hanzi (Pinyin) - Terjemahan Indonesia
               2. Hanzi (Pinyin) - Terjemahan Indonesia
            `;
            await callGemini(prompt, loadingElement, resultElement);
        }
        async function handleStoryGeneration(module) {
            const loadingElement = document.getElementById('story-loading');
            const resultElement = document.getElementById('story-result');
            const vocabList = module.vocabulary.map(v => `${v.char} (${v.translation})`).join(', ');
            const prompt = `
            Anda adalah asisten guru Mandarin HSK 1 yang kreatif.
            Buatlah sebuah cerita yang sangat pendek (sekitar 3-5 kalimat) untuk anak usia 14 tahun.
            
            ATURAN KETAT:
            1. Cerita HANYA boleh menggunakan kosakata dari daftar ini: ${vocabList}.
            2. Jangan gunakan karakter lain di luar daftar HSK 1.
            3. Buat cerita yang lucu atau menarik jika bisa.
            
            FORMAT HASIL (Gunakan tiga baris per kalimat):
            [Baris 1: Hanzi]
            [Baris 2: Pinyin]
            [Baris 3: Terjemahan Indonesia]
            
            Contoh format untuk satu kalimat:
            æˆ‘å«å¤§å«ã€‚
            WÇ’ jiÃ o DÃ wÃ¨i.
            Nama saya David.
            `;
            
            loadingElement.style.display = 'block';
            resultElement.style.display = 'none';
            await callGemini(prompt, loadingElement, resultElement);
            if (resultElement.innerText.trim() !== '' && !resultElement.innerText.startsWith('Gagal')) {
                addXP(25);
            }
        }

    </script>
</body>
</html>